{% extends 'dailyreport/zh-tw/base.html' %}
{% load humanize %}
{% load guardian_tags %}
{% load url from future %}
{% load i18n %}

{% block script %}
    <script type="text/javascript" src="/media/dailyreport/plugin/fullcalendar-3.4.0/lib/moment.min.js{{ settings.SV_ }}"></script>
    <script type="text/javascript" src="/media/dailyreport/plugin/fullcalendar-3.4.0/fullcalendar.min.js{{ settings.SV_ }}"></script>
    <script type="text/javascript" src="/media/dailyreport/plugin/fullcalendar-3.4.0/locale/zh-tw.js{{ settings.SV_ }}"></script>
    <script type="text/javascript" src="/media/dailyreport/plugin/datetimepicker/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="/media/dailyreport/plugin/datetimepicker/zh-TW.js" charset="UTF-8"></script> 

    <link rel="stylesheet" type="text/css" href="/media/dailyreport/plugin/datetimepicker/bootstrap-datetimepicker.min.css{{ settings.SV_ }}">
    <link rel="stylesheet" type="text/css" href="/media/dailyreport/plugin/fullcalendar-3.4.0/fullcalendar.min.css{{ settings.SV_ }}">
    <style>
        .fc-event {
            cursor: pointer;
        }
        .tooltip {
            z-index: 9999999 !important
        }
        .ui-datepicker select.ui-datepicker-month, .ui-datepicker select.ui-datepicker-year {
            width: 45%;
        }
    </style>
    <script type="text/javascript">
        var start_date = "{{ engprofile.start_date|date:'Y-m-d' }}";
    </script>
{% endblock %}
    
{% block body %}

{% include 'dailyreport/zh-tw/menu.html' %}

<input style="display: none;" id="project_id" value="{{ engprofile.project.id }}"></input>
<input style="display: none;" id="report_type" value="{{ report_type }}"></input>
<input style="display: none;" id="can_edit" value="{{ edit }}"></input>

<h3>
    工期調整
</h3>

<div align="center">
    
    
    <div class="row-fluid">
        <div class="span5">
            <h3>
                工期展延 紀錄
                {% if edit %}
                    <a href="#add_Extention" role="button" class="btn btn-success" data-toggle="modal">新增展延/變更設計</a>
                {% endif %}
            </h3>
            
            <table class="table table-bordered" align="center">
                <col width="6%">
                <col width="12%">
                <col width="10%">
                <col width="20%">
                <col width="30%">
                {% if edit %}
                    <col width="6%">
                {% endif %}
                <tr>
                    <td style="text-align: center;" bgcolor="#CAE1FF">序號</td>
                    <td style="text-align: center;" bgcolor="#CAE1FF">天數</td>
                    <td style="text-align: center;min-width: 85px" bgcolor="#CAE1FF">生效日期</td>
                    <td style="text-align: center;" bgcolor="#CAE1FF">文號</td>
                    <td style="text-align: center;" bgcolor="#CAE1FF">備註</td>
                    {% if edit %}
                        <td style="text-align: center;" bgcolor="#CAE1FF"><span></span></td>
                    {% endif %}
                </tr>
                {% for ex in extensions %}
                    {% include 'dailyreport/zh-tw/tr_extension.html' %}
                {% endfor %}
            </table>


            
            <!-- 新增展延紀錄的dialog -->
            <div id="add_Extention" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="myModalLabel">新增工期展延紀錄</h3>
                </div>
                <div class="modal-body" style="text-align: center">
                    <p> 
                        <table class="table table-bordered" align="center">
                            <col width="20%">
                            <col width="80%">
                            <tr>
                                <td bgcolor="#CAE1FF">天數<i class="icon-star"></i></td>
                                <td>
                                    <div class="input-append">
                                        <input type="text" name="extension_day" id="extension_day" placeholder="請輸入天數…">
                                        <span class="add-on">天</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td bgcolor="#CAE1FF">生效日期<i class="icon-star"></i></td>
                                <td>
                                    <input do_nothing="true" class="datepicker" type="text" name="extension_date" id="extension_date" placeholder="請輸入生效日期…">
                                </td>
                            </tr>
                            <tr>
                                <td bgcolor="#CAE1FF">文號</td>
                                <td>
                                    <input type="text" name="extension_no" id="extension_no" placeholder="請輸入文號…">
                                </td>
                            </tr>
                            <tr>
                                <td bgcolor="#CAE1FF">備註</td>
                                <td>
                                    <textarea name="extension_memo" id="extension_memo" placeholder="請輸入備註…"></textarea>
                                </td>
                            </tr>
                        </table>
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
                    <button class="btn btn-primary" id="add_extension_record">新增</button>
                </div>
            </div>









            <br>
            <h3>
                停工/休息日/強制開工 紀錄
                {% if edit %}
                    <button class="btn btn btn-success" type="button" href="#create_special_date_dialog" data-toggle="modal">新增一個紀錄</button>
                    <button class="btn btn btn-info" type="button" href="#import_holiday_dialog" data-toggle="modal">選擇匯入休息日</button>
                {% endif %}
            </h3>
            <div class="alert" align="left">
                <ol style="text-align: left;" align="left">
                    <li>若有同一天皆設定有多種類，則採用順序為<span style="color: red;">「強制開工」＞「停工/休息日」</span>。</li>
                    <li style="font-size: 17px;">若設定「停工/休息日」，則期間所填寫的<u>日報表完成數量</u><span style="color: red;">將會被歸零。</span></li>
                </ol>
            </div>
            
            <table class="table table-bordered" align="center">
                <col width="12%">
                <col width="10%">
                <col width="10%">
                <col width="10%">
                <col width="20%">
                <col width="30%">
                {% if edit %}
                    <col width="11%">
                {% endif %}
                <tr bgcolor="#91FF92">
                    <td style="text-align: center;min-width: 65px">種類</td>
                    <td style="text-align: center;min-width: 85px">開始日期</td>
                    <td style="text-align: center;min-width: 85px">結束日期</td>
                    <td style="text-align: center;min-width: 85px">生效日期</td>
                    <td style="text-align: center;">文號</td>
                    <td style="text-align: center;">原因</td>
                    {% if edit %}
                        <td style="text-align: center;min-width: 40px"><span></span></td>
                    {% endif %}
                </tr>
                {% for sd in special_dates %}
                    {% include 'dailyreport/zh-tw/tr_special_date.html' %}
                {% endfor %}
                <tr style="display:none;" id="special_date_insert_place"></tr>
            </table>

            <!-- 新增停工/強制開工的dialog -->
            <div id="create_special_date_dialog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="myModalLabel">新增紀錄</h3>
                </div>
                <div class="modal-body" style="text-align: center" align="center">
                    <table class="table table-bordered">
                        <col width="30%">
                        <col width="70%">
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">種　　類：</td>
                            <td>
                                <select id="special_date_type">
                                    <option value=""></option>
                                    {% for type in choose.special_date %}
                                        <option value="{{ type.id }}">{{ type.value }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">開始日期：</td>
                            <td>
                                <input id="special_date_start_date" type="text" do_nothing="true" class="datepicker" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">結束日期：</td>
                            <td>
                                <input id="special_date_end_date" type="text" do_nothing="true" class="datepicker noless_then" 
                                       target="special_date_start_date" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">生效日期：</td>
                            <td>
                                <input id="special_date_begin_date" type="text" do_nothing="true" class="datepicker" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">文號：</td>
                            <td>
                                <input id="special_date_no" type="text" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">原　　因：</td>
                            <td>
                                <textarea id="special_date_reason"></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
                    <button class="btn btn-primary" id="create_special_date">新增紀錄</button>
                </div>
            </div>

            <!-- 修改停工/強制開工的dialog -->
            <div id="update_special_date_dialog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="myModalLabel">修改紀錄</h3>
                </div>
                <div class="modal-body" style="text-align: center" align="center">
                    <table class="table table-bordered">
                        <col width="30%">
                        <col width="70%">
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">種　　類：</td>
                            <td>
                                <select id="update_special_date_type">
                                    <option value=""></option>
                                    {% for type in choose.special_date %}
                                        <option value="{{ type.id }}">{{ type.value }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">開始日期：</td>
                            <td>
                                <input id="update_special_date_start_date" type="text" do_nothing="true" class="datepicker" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">結束日期：</td>
                            <td>
                                <input id="update_special_date_end_date" type="text" do_nothing="true" class="datepicker noless_then" 
                                       target="update_special_date_start_date" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">生效日期：</td>
                            <td>
                                <input id="update_special_date_begin_date" type="text" do_nothing="true" class="datepicker" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">文號：</td>
                            <td>
                                <input id="update_special_date_no" type="text" value="">
                            </td>
                        </tr>
                        <tr>
                            <td bgcolor="#73B7FF" style="text-align: center;">原　　因：</td>
                            <td>
                                <textarea id="update_special_date_reason"></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
                    <button class="btn btn-primary" id="update_special_date" row_id="">修改紀錄</button>
                </div>
            </div>


            <!-- 匯入國定假日休息日dialog -->
            <div id="import_holiday_dialog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width:1000px;margin-left: -500px">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="myModalLabel">選擇匯入休息日</h3>
                </div>
                <div class="modal-body" style="text-align: center" align="center">
                    <table class="table table-bordered">
                        <col width="8%">
                        <col width="12%">
                        <col width="15%">
                        <col width="65%">
                        <thead>
                            <tr style="background-color: #AEFFDA">
                                <th>匯入</th>
                                <th>日期</th>
                                <th>名稱</th>
                                <th>說明</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for h in holidays %}
                                <tr>
                                    <td><button type="button" class="btn btn-success import_holiday" isHoliday="{{ h.isHoliday }}">匯入</button></td>
                                    <td name="date">{{ h.date|date:'Y-m-d' }}</td>
                                    <td name="name">{% if h.name %}{{ h.name }}{% else %}{{ h.holidayCategory }}{% endif %}</td>
                                    <td name="memo">{{ h.description }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">關閉</button>
                </div>
            </div>
        </div>



















        <div class="span7">
            <div class="alert" align="left">
                <h4 style="line-height: 26px;">點擊事件可觀看事件詳細說明。
                <button style="float:right" class="btn btn-info" type="button" onclick='window.location="/dailyreport/make_excel_working_date/{{ engprofile.project.id }}/"'>匯出工期彙整Excel</button>
                </h4>
            </div>
            <div id="need_reload" class="alert alert-success" align="left" style="display:none;">
                <h4 style="line-height: 26px;">您的設定有變動，需 <button type="button" class="btn btn-info btn-large" onclick="window.location.reload()">重新整理</button>。</h4>
            </div>
            <div style="position:relative;background-color: white;">
                <div id='calendar' style="padding:8px;box-shadow: 4px 4px 3px rgba(20%,20%,40%,0.5);"></div>
            </div>
            <script type="text/x-jquery-tmpl" id="picker_layout">
                <div id="month_picker" class="input-group date" style="margin-top:5px; ">
                    <input class="form-control" type="text" value="{{ last_day.year }}-{{ last_day.month }}" style="display: none">
                    <span class="input-group-addon" style="padding:5px;white-space:nowrap; border: 2px solid #c0c2c7; width: 100%;">
                        <span class="glyphicon glyphicon-calendar"></span> 切換月份
                    </span>
                </div>
            </script>
        </div>
    </div>
</div>


<!-- 日期事件的dialog -->
<div id="date_event_dialog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">日期事件說明</h3>
    </div>
    <div class="modal-body" style="text-align: center">
        <table class="table table-bordered" id="table_date_event">
            <col width="20%">
            <col width="80%">.
            <tr>
                <td style="background-color: #afd6ff" align="center">事件</td>
                <td name="title"></td>
            </tr>
            <tr>
                <td style="background-color: #afd6ff" align="center">日期</td>
                <td name="date_range"></td>
            </tr>
            <tr>
                <td style="background-color: #afd6ff" align="center">說明</td>
                <td name="date_memo"></td>
            </tr>
        </table>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">關閉</button>
    </div>
</div>





















<!-- JavaScript -->
    <script type="text/javascript">
        function add_extension_record(){
            var $obj = $(this);
            var project_id = $('#project_id').val();
            var type = $('#extension_type').val();
            var day = $('#extension_day').val();
            var date = $('#extension_date').val();
            var no = $('#extension_no').val();
            var memo = $('#extension_memo').val();
            if (!day || !float_check.test(day)) {
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入展延天數",
                });
                return false;
            };
            if (!date) {
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入生效日期",
                });
                return false;
            };

            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                project: '/project/api/v1/project/' + project_id + '/',
                type: type,
                day: day,
                date: date,
                no: no,
                memo: memo
            };
            $.ajax({
                url: '/dailyreport/api/v1/extension/',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    Lobibox.notify('success', {
                        title: '系統訊息',
                        msg: "新增展延成功!!!",
                    });
                    setTimeout('window.location.reload()', 1000);
                },
                error: function (json) {
                    Lobibox.notify('error', {
                        title: '錯誤訊息',
                        msg: json.responseText,
                    });
                },
            })
        }

        function delete_extension(){
            var $obj = $(this);
            var row_id = $obj.attr('row_id');
            var ex_day = parseInt($('#edit_part_day_' + row_id).val(), 10);
            Lobibox.confirm({
                msg: '確定要刪除這個工期展延紀錄嗎？',
                buttons: {
                    accept: {
                        'class': 'lobibox-btn lobibox-btn-yes',
                        text: '確定刪除',
                        closeOnClick: true
                    },
                    cancel: {
                        'class': 'lobibox-btn lobibox-btn-no',
                        text: '取消',
                        closeOnClick: true
                    },
                },
                callback: function ($this, type, ev) {
                    if(type=="accept"){
                        var data = {
                            csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                        };
                        $.ajax({
                            url: '/dailyreport/api/v1/extension/' + row_id + '/',
                            type: 'DELETE',
                            data: JSON.stringify(data),
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function (json, text, xhr) {
                                Lobibox.notify('success', {
                                    title: '系統訊息',
                                    msg: "已刪除展延",
                                });
                                $('#tr_extension_' + row_id).remove();
                                var day = parseInt($('#extension_total_day').html(), 10);
                                $('#extension_total_day').html(day - ex_day);
                                $('#need_reload').show();
                            },
                            error: function (json) {
                                Lobibox.notify('error', {
                                    title: '錯誤訊息',
                                    msg: json.responseText,
                                });
                            },
                        });
                    }else{
                        return false;
                    }
                }
            });
        }

        function create_special_date(){
            var project_id = $('#project_id').val();
            var special_date_type = $('#special_date_type').val();
            var special_date_start_date = $('#special_date_start_date').val();
            var special_date_end_date = $('#special_date_end_date').val();
            var special_date_reason = $('#special_date_reason').val();
            if (!special_date_type){ 
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請選擇設定種類",
                }); 
                return false;
            };
            if (!special_date_start_date){ 
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入開始日期",
                });
                return false;
            };
            if (!special_date_end_date){
                special_date_end_date = special_date_start_date;
            };
            if (!special_date_reason){ 
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入原因",
                });
                return false;
            };
            var special_date_begin_date = $('#special_date_begin_date').val();
            if (!special_date_begin_date){
                special_date_begin_date = special_date_start_date;
            };
            var special_date_no = $('#special_date_no').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                project_id: project_id,
                type_id: special_date_type,
                start_date: special_date_start_date,
                end_date: special_date_end_date,
                reason: special_date_reason,
                begin_date: special_date_begin_date,
                no: special_date_no
            };

            $.ajax({
                url: '/dailyreport/api/v1/report/?project=' + project_id + '&date__gte=' + special_date_start_date + '&date__lte=' + special_date_end_date,
                type: 'GET',
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    if (json.objects.length != 0){
                        Lobibox.confirm({
                            msg: '系統警告!!!! 您設定的區間有填報紀錄共《' + json.objects.length + '》天，若設定停工/休息日/勒令停工，系統會將此日期區間的填報數量《全部歸 0 》(無法恢復)，是否確定繼續新增此設定？',
                            buttons: {
                                accept: {
                                    'class': 'lobibox-btn lobibox-btn-yes',
                                    text: '確定新增',
                                    closeOnClick: true
                                },
                                cancel: {
                                    'class': 'lobibox-btn lobibox-btn-no',
                                    text: '取消',
                                    closeOnClick: true
                                },
                            },
                            callback: function ($this, type, ev) {
                                if(type=="accept"){
                                    create_special_day_record(data);
                                }else{
                                    return false;
                                }
                            }
                        });
                    } else {
                        create_special_day_record(data);
                    }
                },
                error: function(e){
                }
            })

            function create_special_day_record(data){
                $.ajax({
                    url: '/dailyreport/create_special_date/',
                    type: 'POST',
                    data: data,
                    dataType: 'json',
                    success: function (json) {
                        if (json['status']){
                            var html = $(json['html']);
                            $('#special_date_start_date').val('');
                            $('#special_date_end_date').val('');
                            $('#special_date_begin_date').val('');
                            $('#special_date_no').val('');
                            $('#special_date_reason').val('');
                            html.insertBefore($('#special_date_insert_place'));
                            $('.deleteRow', html).click(deleteRow);
                            $('.show_update_dialog', html).click(show_update_dialog);
                            $('#create_special_date_dialog').modal('hide');
                        } else {
                            Lobibox.notify('error', {
                                title: '錯誤訊息',
                                msg: json['msg'],
                            });
                        }
                    },
                    error: function (json) {
                        Lobibox.notify('error', {
                            title: '錯誤訊息',
                            msg: json.responseText,
                        });
                    },
                })
            }
        }

        function update_special_date() {
            //修改停工設定
            var $obj = $(this);
            var row_id = $obj.attr('row_id');
            $('#tr_special_date_' + row_id).remove();
            var project_id = $('#project_id').val();
            var special_date_type = $('#update_special_date_type').val();
            var special_date_start_date = $('#update_special_date_start_date').val();
            var special_date_end_date = $('#update_special_date_end_date').val();
            var special_date_reason = $('#update_special_date_reason').val();
            if (!special_date_type){ 
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請選擇設定種類",
                });
                return false;
            };
            if (!special_date_start_date){
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入開始日期",
                });
                return false; 
            };
            if (!special_date_end_date){
                special_date_end_date = special_date_start_date;
            };
            if (!special_date_reason){ 
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入原因",
                });
                return false;
            };
            var special_date_begin_date = $('#update_special_date_begin_date').val();
            var special_date_no = $('#update_special_date_no').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                project_id: project_id,
                type_id: special_date_type,
                start_date: special_date_start_date,
                end_date: special_date_end_date,
                reason: special_date_reason,
                begin_date: special_date_begin_date,
                no: special_date_no
            };
            $.ajax({
                url: '/dailyreport/api/v1/report/?project=' + project_id + '&date__gte=' + special_date_start_date + '&date__lte=' + special_date_end_date,
                type: 'GET',
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    if (json.objects.length != 0){
                        Lobibox.confirm({
                            msg: '系統警告!!!! 您設定的區間有填報紀錄共《' + json.objects.length + '》天，若設定停工/休息日/勒令停工，系統會將此日期區間的填報數量《全部歸 0 》(無法恢復)，是否確定繼續修改此設定？',
                            buttons: {
                                accept: {
                                    'class': 'lobibox-btn lobibox-btn-yes',
                                    text: '確定新增',
                                    closeOnClick: true
                                },
                                cancel: {
                                    'class': 'lobibox-btn lobibox-btn-no',
                                    text: '取消',
                                    closeOnClick: true
                                },
                            },
                            callback: function ($this, type, ev) {
                                if(type=="accept"){
                                    update_special_date_record(data, row_id);
                                }else{
                                    return false;
                                }
                            }
                        });
                    } else {
                        update_special_date_record(data, row_id);
                    }
                },
                error: function(e){
                }
            })
            function update_special_date_record(data, row_id){
                $.ajax({
                    url: '/dailyreport/api/v1/specialdate/' + row_id + '/',
                    type: 'DELETE',
                    dataType: 'json',
                    success: function (json) {
                        $.ajax({
                            url: '/dailyreport/create_special_date/',
                            type: 'POST',
                            data: data,
                            dataType: 'json',
                            success: function (json) {
                                if (json['status']){
                                    var html = $(json['html']);
                                    $('#update_special_date_start_date').val('');
                                    $('#update_special_date_end_date').val('');
                                    $('#update_special_date_begin_date').val('');
                                    $('#update_special_date_no').val('');
                                    $('#update_special_date_reason').val('');
                                    html.insertBefore($('#special_date_insert_place'));
                                    $('.deleteRow', html).click(deleteRow);
                                    $('.show_update_dialog', html).click(show_update_dialog);
                                    $('#update_special_date_dialog').modal('hide');
                                } else {
                                    Lobibox.notify('warning', {
                                        title: '警告訊息',
                                        msg: json['msg'],
                                    });
                                }
                            },
                            error: function (json) {
                                Lobibox.notify('error', {
                                    title: '錯誤訊息',
                                    msg: json.responseText,
                                });
                            },
                        })
                    },
                    error: function (json) {
                        Lobibox.notify('error', {
                            title: '錯誤訊息',
                            msg: json.responseText,
                        });
                    },
                })
            }
        }

        function show_update_dialog() {
            //show修改停工設定dialog
            var row_id = $(this).attr('row_id');
            $.ajax({
                url: '/dailyreport/api/v1/specialdate/' + row_id + '/',
                type: 'GET',
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    $('#update_special_date_type').val(json['type'].split('/')[5]);
                    $('#update_special_date_start_date').val(json['start_date']);
                    $('#update_special_date_end_date').val(json['end_date']);
                    $('#update_special_date_begin_date').val(json['begin_date']);
                    $('#update_special_date_no').val(json['no']);
                    $('#update_special_date_reason').val(json['reason']);
                    $('#update_special_date').attr('row_id', row_id);
                    $('#update_special_date_dialog').modal('show');
                },
                error: function (json) {
                    Lobibox.notify('error', {
                        title: '錯誤訊息',
                        msg: json.responseText,
                    });
                },
            })
        }
        
        function import_holiday(){
            var $obj = $(this);
            var isHoliday = $obj.attr('isHoliday');
            var tr = $obj.closest('tr');
            var name = tr.find('[name="name"]').html();
            var date = tr.find('[name="date"]').html();
            var memo = tr.find('[name="memo"]').html();
            $('#special_date_start_date').val(date);
            $('#special_date_end_date').val(date);
            $('#special_date_begin_date').val(start_date);
            $('#special_date_no').val(name);
            $('#special_date_reason').val(memo);
            if (isHoliday == '是'){
                $('#special_date_type').val('223');
            } else {
                $('#special_date_type').val('222');
            }

            $('#import_holiday_dialog').modal('hide');
            $('#create_special_date_dialog').modal('show');
        }
        $(document).ready(function(){
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,listWeek'
                },
                defaultDate: '{{ last_day }}',
                editable: false,
                eventLimit: true,
                events: [
                {% for i in events %}
                    {
                        title: '{{ i.title }}',
                        start: '{{ i.start }}',
                        end: '{{ i.end }}',
                        textColor: '{{ i.textColor }}',
                        {% if i.rendering %}
                            rendering: '{{ i.rendering }}',
                        {% endif %}
                        backgroundColor: '{{ i.backgroundColor }}',
                        date_range: '{{ i.date_range }}',
                        date_memo: '{{ i.date_memo|safe }}',
                    },
                {% endfor %}
                ],
                // eventMouseover: function(calEvent, jsEvent, view) {
                //     $(this).attr('data-toggle', 'tooltip');
                //     $(this).tooltip({title: calEvent.date_range + calEvent.date_memo});
                //     $(this).tooltip('show');
                // },
                eventClick: function(calEvent, jsEvent, view) {
                    if (calEvent.date_range){
                        $('#table_date_event').find('[name="title"]').html(calEvent.title);
                        $('#table_date_event').find('[name="date_range"]').html(calEvent.date_range);
                        $('#table_date_event').find('[name="date_memo"]').html(calEvent.date_memo);
                        $('#date_event_dialog').modal('show');
                        $(this).css('border-color', 'red');
                    }
                },
                dayClick: function(date, jsEvent, view, resourceObj) {
                    $('.fc-day').css('background-color', '');
                    $(this).css('background-color', 'pink');
                }
            })

            $('.fc-right').append($('#picker_layout').tmpl());

            $('#month_picker').datetimepicker({
                locale: 'zh_TW',
                viewMode: 'years',
                format: 'YYYY-MM',
            });

            $('#month_picker').on('dp.change', function(event) {
                $('#calendar').fullCalendar('gotoDate', event.date.format('YYYY-MM-DD'))
            });

            $('.fc-prev-button').html($('.fc-prev-button').html()+'上月');
            $('.fc-next-button').html('下月' + $('.fc-next-button').html());
            $('<button type="button" class="go_date fc-button fc-state-default fc-corner-left fc-corner-right" date="{{ engprofile.start_date }}">開工日</button>').insertBefore($('.fc-today-button'));
            $('<button type="button" class="go_date fc-button fc-state-default fc-corner-left fc-corner-right" date="{{ engprofile.end_date }}">預計完工日</button>').insertBefore($('.fc-today-button'));
            $('.go_date').click(function(){
                $('#calendar').fullCalendar('gotoDate', $(this).attr('date'));
            });

            $('#add_extension_record').click(add_extension_record);
            $('.delete_extension').click(delete_extension);
            $('#create_special_date').click(create_special_date);
            $('.show_update_dialog').click(show_update_dialog);
            $('#update_special_date').click(update_special_date);
            $('.deleteRow').click(deleteRow);
            $('.import_holiday').click(import_holiday);

            $('input, select').change(function(){
                $('#need_reload').show();
            });
        });
    </script>
{% endblock %}