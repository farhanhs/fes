{% extends 'dailyreport/zh-tw/base.html' %}
{% load humanize %}
{% load guardian_tags %}
{% load i18n %}

{% block body %}
    {% include 'dailyreport/zh-tw/menu.html' %}
    <h3>
        填寫每日報表
    </h3>
    <input style="display: none;" id="report_id" value=""></input>
    <input style="display: none;" id="report_date" value=""></input>
    <input style="display: none;" id="project_id" value="{{ engprofile.project.id }}"></input>
    <input style="display: none;" id="report_type" value="{{ report_type }}"></input>
    <input style="display: none;" id="can_edit" value="{{ edit }}"></input>
    <input style="display: none;" id="tmp_reported_date"></input>
    
    
    <div>
        <img src="/media/dailyreport/images/restday.png">休息日　
        <img src="/media/dailyreport/images/workday.png">已填寫　
        <img src="/media/dailyreport/images/no_work.png">停工　
        <img src="/media/dailyreport/images/date_off_reported.png">停工有填寫　
        <img src="/media/dailyreport/images/forcework.png">強制開工
    </div>
    <br>
    <div align="center" id="datepicker"></div>

    <table align="center">
        <tr>
            <td style="text-align:center;">
                <div>
                    工期計算方式: {{ engprofile.date_type.value }}
                    {% ifequal engprofile.date_type.value "限期完工(日曆天每日施工)" %}
                    {{ engprofile.deadline }}
                </div>
                {% endifequal %}
                <div>實際開工日期: {{ engprofile.start_date }}</div>
                <div>預定完工日期: {{ engprofile.end_date }}</div>
                <br/>
            </td>
        </tr>
    </table>

    <h1 id="reason" class="hidden"></h1>
    <table class="table table-bordered" id="reports" align="center" style="table-layout:fixed;width: 800px;">
        <caption><h4>所有已填過之報表</h4></caption>
        <col width="15%">
        <col width="85">
        {% for report in engprofile.readAllReportGroupByMonth %}
            <tr>
                <td style="text-align: center;" bgcolor="#FFBB73">{{ report.key }}</td>
                <td align="left" bgcolor="white">
                    {% for r in report.value %}
                        <a class="updateReportPage" report_date='{{ r.date|date:"Y-m-d" }}'
                            href='/dailyreport/report/{{ engprofile.project.id }}/{{ report_type }}/#{{ r.date|date:"Y-m-d" }}'>
                            {{ r.date.day }}
                        </a>
                        <span style="margin: -3px ;padding: 1 3 3 3; border-radius:11px;{% if r.is_diff %} background-color: black;{% endif %}">
                        {% if r.inspector_check %}<img src="/media/dailyreport/images/blue_ball.png" width="8" title="監造填寫完畢">{% else %}<img src="/media/dailyreport/images/blue_ball_empty.png" width="8" title="監造尚未填寫">{% endif %}{% if r.contractor_check %}<img src="/media/dailyreport/images/red_ball.png" width="8" title="施工填寫完畢">{% else %}<img src="/media/dailyreport/images/red_ball_empty.png" width="8" title="施工尚未填寫">{% endif %}</span>
                        ,
                        {% if forloop.last %}
                            共 {{ forloop.counter }} 日。
                        {% endif %}
                    {% endfor %}
                </td>
            </tr>
        {% endfor %}
    </table>

    <table class="table table-bordered" id="no_reports" align="center" style="table-layout:fixed;width: 800px;">
        <caption><h4>尚未填寫的報表</h4></caption>
        <col width="15%">
        <col width="42.5">
        <col width="42.5">
        <tr class="info">
            <td style="text-align: center;">月份</td>
            <td style="text-align: center;">監造尚未填寫</td>
            <td style="text-align: center;">施工尚未填寫</td>
        </tr>
        {% for report in engprofile.readNotCompleteReportGroupByMonth %}
            <tr>
                <td style="text-align: center;" bgcolor="#FFBB73">{{ report.key }}</td>
                <td align="left" bgcolor="white">
                    {% for d in report.value.0 %}
                        <a class="updateReportPage" report_date='{{ d|date:"Y-m-d" }}'
                            href='/dailyreport/report/{{ engprofile.project.id }}/inspector/#{{ d|date:"Y-m-d" }}'>
                            {{ d.day }}
                        </a>
                        ,
                        {% if forloop.last %}
                            共 {{ forloop.counter }} 日。
                        {% endif %}
                    {% endfor %}
                </td>
                <td align="left" bgcolor="white">
                    {% for d in report.value.1 %}
                        <a class="updateReportPage" report_date='{{ d|date:"Y-m-d" }}'
                            href='/dailyreport/report/{{ engprofile.project.id }}/contractor/#{{ d|date:"Y-m-d" }}'>
                            {{ d.day }}
                        </a>
                        ,
                        {% if forloop.last %}
                            共 {{ forloop.counter }} 日。
                        {% endif %}
                    {% endfor %}
                </td>
            </tr>
        {% endfor %}
    </table>

    <div id="loading" style="display:none;font-size:20px;">下載資料... <img width="30" height="30" src="/media/dailyreport/images/loading.gif"/></div>

    <div id="report"></div>

    <div id="date_off_part" style="display: none;">
        <h2 id="date_off_message"></h2>
        <br><br><br><br><br><br>
    </div>


<div id="success_message" style="position:fixed;top:50%;left:40%;visibility:visible;display: none;">
    <span style="font-size: 40px;" class="btn btn-large btn-primary"><br>---更新資料成功!!!---<br>________________</span>
</div>








<!-- 新增人員的dialog -->
<div id="create_labor_dailog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">新增人員</h3>
    </div>
    <div class="modal-body" style="text-align: center">
        <select id="set_new_labor_name">
            <option value="">請選擇</option>
            <optgroup label="自定義">
                <option value="other">其他種類(自定義名稱)</option>
            </optgroup>
            <optgroup label="工程會標案管理系統類別">
                <option value="現場工程師">現場工程師</option>
                <option value="鋼筋工">鋼筋工</option>
                <option value="模板工">模板工</option>
                <option value="泥水工">泥水工</option>
                <option value="普通工">普通工</option>
                <option value="機械操作工">機械操作工</option>
                <option value="體力工">體力工</option>
                <option value="建築細木工">建築細木工</option>
                <option value="水電工">水電工</option>
                <option value="混凝土澆置工">混凝土澆置工</option>
                <option value="路面鋪設工">路面鋪設工</option>
                <option value="砌石工">砌石工</option>
                <option value="其他工">其他工</option>
            </optgroup>
        </select>
        <br><br>
        <input style="display:none" type="text" id="new_labor_name" value="" placeholder="請輸入人員種類的名稱">
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
        <button class="btn btn-primary create_labor_or_equip" type="labor">確定新增人員種類</button>
    </div>
</div>

<script type="text/javascript">
    $('#set_new_labor_name').change(
        function (){
            var $obj = $(this);
            var value = $obj.val();
            if (value == 'other'){
                $('#new_labor_name').show();
                $('#new_labor_name').val("");
            } else {
                $('#new_labor_name').hide();
                $('#new_labor_name').val(value);
            }
        }
    );
</script>

<!-- 新增機具的dialog -->
<div id="create_equip_dailog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">新增機具</h3>
    </div>
    <div class="modal-body" style="text-align: center">
        <select id="set_new_equip_name">
            <option value="">請選擇</option>
            <optgroup label="自定義">
                <option value="other">其他種類(自定義名稱)</option>
            </optgroup>
            <optgroup label="工程會標案管理系統類別">
                <optgroup label="● 土方機具">
                    <option value="挖土機">挖土機</option>
                    <option value="推土機">推土機</option>
                    <option value="裝載機">裝載機</option>
                    <option value="刮運機">刮運機</option>
                    <option value="門式抓鬥">門式抓鬥</option>
                    <option value="拖車">拖車</option>
                    <option value="傾卸車">傾卸車</option>
                    <option value="鏟裝車">鏟裝車</option>
                </optgroup>
                <optgroup label="● 基礎機具">
                    <option value="反循環鑽挖機">反循環鑽挖機</option>
                    <option value="衝擊式鑽挖機">衝擊式鑽挖機</option>
                    <option value="全套管鑄樁機">全套管鑄樁機</option>
                    <option value="連續壁鑽頭">連續壁鑽頭</option>
                    <option value="連續壁抓鬥">連續壁抓鬥</option>
                    <option value="挖戽式連續壁工作機組">挖戽式連續壁工作機組</option>
                    <option value="鑽孔機">鑽孔機</option>
                    <option value="拔管機">拔管機</option>
                    <option value="打樁機">打樁機</option>
                    <option value="履帶式挖吊機">履帶式挖吊機</option>
                    <option value="樁錘">樁錘</option>
                </optgroup>
                <optgroup label="● 混凝土機具">
                    <option value="混凝土灌漿機">混凝土灌漿機</option>
                    <option value="混凝土幫浦">混凝土幫浦</option>
                    <option value="混凝土幫浦送水車">混凝土幫浦送水車</option>
                    <option value="混凝土噴佈機">混凝土噴佈機</option>
                    <option value="混凝土澆築臂">混凝土澆築臂</option>
                    <option value="混凝土整平機">混凝土整平機</option>
                    <option value="混凝土拌合機">混凝土拌合機</option>
                    <option value="混凝土鋪築機">混凝土鋪築機</option>
                    <option value="混凝土拌合車">混凝土拌合車</option>
                    <option value="混凝土振動機">混凝土振動機</option>
                </optgroup>
                <optgroup label="● 路面機具">
                    <option value="平路機">平路機</option>
                    <option value="刨路機">刨路機</option>
                    <option value="瀝青拌合機">瀝青拌合機</option>
                    <option value="瀝青撒佈機">瀝青撒佈機</option>
                    <option value="瀝青鋪築機">瀝青鋪築機</option>
                    <option value="鐵輪式壓路機">鐵輪式壓路機</option>
                    <option value="膠輪式壓路機">膠輪式壓路機</option>
                    <option value="震動式壓路機">震動式壓路機</option>
                    <option value="羊角式壓路機">羊角式壓路機</option>
                    <option value="標線車">標線車</option>
                </optgroup>
                <optgroup label="● 隧道機具">
                    <option value="隧道鑽挖機">隧道鑽挖機</option>
                    <option value="鑽堡機">鑽堡機</option>
                    <option value="履帶式鑽岩機">履帶式鑽岩機</option>
                    <option value="輪胎式鑽岩機">輪胎式鑽岩機</option>
                    <option value="潛盾機">潛盾機</option>
                    <option value="推管機">推管機</option>
                    <option value="搖管機">搖管機</option>
                    <option value="隧道機車頭">隧道機車頭</option>
                    <option value="火車裝載機">火車裝載機</option>
                    <option value="推進工法機組">推進工法機組</option>
                </optgroup>
                <optgroup label="● 吊裝機具">
                    <option value="輪胎式吊車">輪胎式吊車</option>
                    <option value="履帶式吊車">履帶式吊車</option>
                    <option value="塔式吊車">塔式吊車</option>
                    <option value="門式吊車">門式吊車</option>
                    <option value="索道吊車">索道吊車</option>
                    <option value="固定雙軌吊車">固定雙軌吊車</option>
                    <option value="吊卡車">吊卡車</option>
                </optgroup>
                <optgroup label="● 高空機具">
                    <option value="懸臂工作車組">懸臂工作車組</option>
                    <option value="支撐先進工作車組">支撐先進工作車組</option>
                    <option value="節塊推進工作車組">節塊推進工作車組</option>
                    <option value="全跨預鑄吊裝工作車組">全跨預鑄吊裝工作車組</option>
                </optgroup>
                <optgroup label="● 港灣機具">
                    <option value="拖船">拖船</option>
                    <option value="交通船">交通船</option>
                    <option value="拋石船">拋石船</option>
                    <option value="挖泥船">挖泥船</option>
                    <option value="潛水船">潛水船</option>
                    <option value="打樁船">打樁船</option>
                    <option value="平臺船">平臺船</option>
                    <option value="抽砂船">抽砂船</option>
                    <option value="水/油駁船">水/油駁船</option>
                    <option value="加壓船">加壓船</option>
                    <option value="多用途工作船">多用途工作船</option>
                </optgroup>
            </optgroup>
        </select>
        <br><br>
        <input type="text" style="display:none" id="new_equip_name" value="" placeholder="機具種類的名稱">
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
        <button class="btn btn-primary create_labor_or_equip" type="equip">確定新增機具種類</button>
    </div>
</div>

<script type="text/javascript">
    $('#set_new_equip_name').change(
        function (){
            var $obj = $(this);
            var value = $obj.val();
            if (value == 'other'){
                $('#new_equip_name').show();
                $('#new_equip_name').val("");
            } else {
                $('#new_equip_name').hide();
                $('#new_equip_name').val(value);
            }
        }
    );
</script>

<!-- 更新人員機具名稱的dialog -->
<div class="modal hide fade" id="update_labor_equip_name_dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                <h4 class="modal-title" id="myModalLabel">更新人員機具名稱</h4> </div>
            <div class="modal-body">
                新名稱：
                <input type="text" id="new_labor_equip_name">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" id="update_labor_equip_name" onclick="update_labor_equip_name()">確定</button>
            </div>
        </div>
    </div>
</div>







<!-- JavaScript -->
    <script type="text/javascript">
        jQuery.fromStringtoDateObj = function (date){
            var array = date.split('-');
            var d = new Date(array[0], Number(array[1])-1, array[2]);
            return d;
        }

        jQuery.fromDateObjtoString = function (dateObj){
            var year = dateObj.getFullYear();
            var month = dateObj.getMonth()+1;
            if (month <= 9){
                month = '0' + month;
            }
            var date = dateObj.getDate();
            if (date <= 9){
                date = '0' + date;
            }
            return year + '-' + month + '-' + date;
        }

        var float_check = /^[+|-]?\d*\.?\d*$/;
        var date_check = /^(([1-9]\d{0,3}|0)\-\d{2}\-\d{2})|(([1-9]\d{0,3}|0)\.\d{2}\.\d{2})|(([1-9]\d{0,3}|0)\/\d{2}\/\d{2})$/;
        var project_id = $('#project_id').val();
        var report_type = $('#report_type').val();
        var report_date = String(window.location).split('#')[1];
        if (report_date) {
            var report_date_obj = $.fromStringtoDateObj(report_date);
        } else {
            var report_date_obj = new Date();
        }
        var offset_days = (report_date_obj - new Date()) / (1000*60*60*24);
        {% ifequal report_type "contractor" %}
            var color_dates = {{ engprofile.readColorDateOfContractorReport|safe }};
        {% else %}
            var color_dates = {{ engprofile.readColorDateOfInspectorReport|safe }};
        {% endifequal %}

        $('.noless_then').change(function(){
            var $obj = $(this);
            var value = $obj.val();
            var target = $obj.attr('target');
            var target_value = $('#' + target).val();
            if (target_value && value){
                if (!date_check.test(target_value)){
                    alert('開始日期需為日期格式!!!');
                    return false;
                }
                if (!date_check.test(value)){
                    alert('結束日期需為日期格式!!!');
                    return false;
                }
                var startArray = target_value.split("-");
                var endArray = value.split("-");
                var start = new Date(startArray[0], startArray[1], startArray[2]);
                var end = new Date(endArray[0], endArray[1], endArray[2]);
                if (start > end){
                    $obj.attr('value', target_value);
                    alert('結束日期必須晚於或等於開始日期!!!');
                    return false;
                }
            }
        });

        var updateColorDateOnDatePicker = function (date) {
            var date_str = $.fromDateObjtoString(date);
            var date_type = '{{ engprofile.date_type.value }}';
            var is_weekend = false;
            if (date_type == '日曆天(僅周日不計)'){
                if (date.getDay() == 0) {
                    is_weekend = true;
                }
            } else if (date_type == '日曆天(不含六日)' || date_type == '工作天'){
                if (date.getDay() == 0 || date.getDay() == 6) {
                    is_weekend = true;
                }
            }
            if (color_dates[date_str]){
                if (color_dates[date_str] == 'date_on') {
                    return [true, 'dailyreport date_on '+date_str, '強制開工'];
                } else if (color_dates[date_str] == 'date_off') {
                    return [true, 'dailyreport date_off '+date_str, '停工'];
                } else if (color_dates[date_str] == 'date_off_rest') {
                    return [true, 'dailyreport date_off_rest '+date_str, '休息日'];
                } else if (color_dates[date_str] == 'date_off_reported') {
                    return [true, 'dailyreport date_off_reported '+date_str, '停工有填寫'];
                } else {
                    return [true, 'dailyreport reported '+date_str, '已填過報表'];
                }
            } else if (is_weekend) {
                if (date_type == '日曆天(僅周日不計)' || date_type == '日曆天(不含六日)' || date_type == '工作天'){
                    return [true, 'dailyreport date_off_weekend '+date_str, '周末假期'];
                } else {
                    return [true, 'dailyreport '+date_str, '周末假期'];
                }
            } else {
                return [true, 'dailyreport '+date_str, '尚未填寫報表'];
            }
        }

        var updateReportPage = function (report_date) {
            $('#reports').hide();
            $('#no_reports').hide();
            $('#report').hide();
            $('#date_off_part').hide();
            var project_id = $('#project_id').val();
            var report_type = $('#report_type').val();

            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                project_id: project_id,
                report_type: report_type,
                report_date: report_date,
            }
            $.ajax({
                url: '/dailyreport/update_report_page/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    if (json['status']){
                        var report_template_version_id = json['report_template_version_id'];
                        var url = json['url'];
                        
                        //檢查樣板是否存在，不存在就即時製造一個
                        $.get('/dailyreport/get_report_template/' + url, function(text) {
                            // $('#report').html(data);
                            if (!document.getElementById(report_template_version_id)){
                                var html = '<script type="text/x-jquery-tmpl" id="' + report_template_version_id + '">';
                                html += text + '</scr' + 'ipt>';
                                $(document.body).append(html);
                            }
                            make_report_html(data, report_template_version_id);
                        });
                        
                    } else {
                        $('#date_off_message').show();
                        $('#date_off_message').html(json['msg']);
                        $('#date_off_part').show();
                    }
                    $('.' + report_date).attr('style', 'border: 3px solid red !important;');
                },
                error: function(){
                }
            })
        }

        function make_report_html(data, report_template_version_id) {
            $('#report').html($('#'+report_template_version_id).tmpl({}));
            $('#report').show();
            if (new Date(data['report_date']) < new Date('2017-08-01')){
                $('.v_new').remove();
            } else {
                $('.v_old').remove();
                if (data['report_type'] == 'inspector'){
                    $('#tr_describe_subcontractor').insertBefore($('#tr_notify'));
                    $('#tr_describe_subcontractor2').insertBefore($('#tr_notify'));
                }
            }
            //讀取本日的值
            $.ajax({
                url: '/dailyreport/get_report_data/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    if (json['profile_data']['is_special_day']){
                        $('#report_items').remove();
                        $('#report_material_items').remove();
                        $('#report_labors_and_equips').remove();
                        $('#tr_has_professional_item').remove();
                        $('.update_report_data').attr('is_special_day', 'true');
                        $('#excel_print_blank').remove();
                        $('#excel_print_all').remove();
                        $('#online_print_blank').remove();
                        $('#online_print_all').remove();
                        $('#excel_print_blank2').remove();
                        $('#excel_print_all2').remove();
                        $('#online_print_blank2').remove();
                        $('#online_print_all2').remove();
                        $('#date_off_message').show();
                        $('#date_off_message').html('今天因為『工期計算方式』或『停工/強制開工設定』，今日停工無法填寫施工數量(不計工期)！<br>如要列印，則至少必須送出資料一次。');
                        $('#report_date').val(data['report_date']);
                    } else {
                        $('#report_id').val(json['profile_data']['report_id']);
                        $('#report_date').val(data['report_date']);
                        $('#lock_report').attr('report_id', json['profile_data']['report_id']);
                        if (json['lock_c']){
                            if (data['report_type']=='contractor'){
                                $('#lock_report_msg').show();
                            }
                            $('#lock_report').attr('is_lock', 'true');
                            $('#lock_report').addClass('btn-success');
                            $('#lock_report').html('解除鎖定' + data['report_date'] + '的日報表');
                        } else {
                            $('#lock_report').attr('is_lock', 'false');
                            $('#lock_report').addClass('btn-danger');
                            $('#lock_report').html('鎖定' + data['report_date'] + '的日報表，不允許修改');
                        }
                        if (json['have_delete_button']){
                            $('#delete_report_record').show();
                        }
                        if (json['have_lock_button']){
                            $('#lock_report').show();
                        }

                        $('.get_item_sum').unbind('click');
                        $('.get_item_sum').click(get_item_sum);
                        $('.show_all_item_sum').unbind('click');
                        $('.show_all_item_sum').click(show_all_item_sum);
                        //item部分
                        var all_item_ids = '';
                        for (i=0; i<json['item_data'].length; i++){
                            var id = json['item_data'][i][0];
                            var num = json['item_data'][i][1];
                            var another_num = json['item_data'][i][2];
                            // var pre_sum_num = json['item_data'][i][3];
                            // var sum_num = json['item_data'][i][4];
                            var note = json['item_data'][i][5];
                            all_item_ids += id + ',';
                            $('#item_num_' + id).val(num);
                            $('#span_item_num_' + id).html(num);
                            $('#span_item_another_num_' + id).html(another_num);
                            // $('#item_sum_num_' + id).html(sum_num);
                            // $('#item_sum_num_' + id).attr('value', pre_sum_num);
                            $('#item_note_' + id).val(note);
                            $('#span_item_note_' + id).html(note);
                            // var unit_num = remove_TransformThousands($('#td_item_unit_num_' + id).html());
                            // if (parseFloat(unit_num) < parseFloat(sum_num)){
                            //     $('#item_sum_num_' + id).attr('bgcolor', '#FF9291');
                            // } else if (parseFloat(unit_num) == parseFloat(sum_num)) {
                            //     $('#item_sum_num_' + id).attr('bgcolor', '#FDFF73');
                            // }
                            if (json['item_data'][i][1]){
                                $('#span_item_sum_num_' + id).click();
                            }
                        }
                        $('#all_item_ids').val(all_item_ids);

                        //人員機具部分
                        $('#report_labors_tbody').html(json['labor_data']);
                        $('#report_equips_tbody').html(json['equip_data']);
                        $('#report_material_items_tbody').html(json['sitematerial_data']);
                    }

                    $('#morning_weather').val(json['profile_data']['morning_weather'][0]);
                    $('#span_morning_weather').val(json['profile_data']['morning_weather'][1]);
                    $('#afternoon_weather').val(json['profile_data']['afternoon_weather'][0]);
                    $('#span_afternoon_weather').val(json['profile_data']['afternoon_weather'][1]);
                    $('.span_report_date').html(data['report_date']);
                    $('#duration').html(json['profile_data']['duration']);
                    $('#used_duration').html(json['profile_data']['used_duration']);
                    $('#unused_duration').html(json['profile_data']['unused_duration']);
                    $('#engs_price').html(TransformThousands(json['profile_data']['engs_price']));
                    if (json['profile_data']['special_dates_data']){
                        $('#tr_special_dates').show();
                        $('#special_dates_data').html(json['profile_data']['special_dates_data']);
                    }
                    if (json['profile_data']['has_professional_item']){
                        $('#has_professional_item').attr('checked', 'checked');
                    }
                    if (json['profile_data']['pre_education']){
                        $('#pre_education').attr('checked', 'checked');
                    }
                    if (json['profile_data']['safety_equipment']){
                        $('#safety_equipment').attr('checked', 'checked');
                    }
                    if (json['profile_data']['pre_check']){
                        $('#pre_check').attr('checked', 'checked');
                    }
                    if (json['profile_data']['has_insurance']){
                        $('input[name="has_insurance"][row_id="' + json['profile_data']['has_insurance'] + '"]').attr('checked', 'checked');
                    }
                    $('#describe_subcontractor').val(json['profile_data']['describe_subcontractor']);
                    $('#another_describe_subcontractor').append(json['profile_data']['another_describe_subcontractor']);
                    $('#note').val(json['profile_data']['note']);
                    $('#another_note').append(json['profile_data']['another_note']);
                    $('#sampling').val(json['profile_data']['sampling']);
                    $('#another_sampling').append(json['profile_data']['another_sampling']);
                    $('#notify').val(json['profile_data']['notify']);
                    $('#another_notify').append(json['profile_data']['another_notify']);
                    $('#i_pre_check').val(json['profile_data']['i_pre_check']);
                    $('#i_project_status').val(json['profile_data']['i_project_status']);

                    if (data['report_type'] == 'contractor'){
                        $('#tr_note').insertBefore($('#tr_insert_place_for_note'));
                        $('#tr_note_2').insertBefore($('#tr_insert_place_for_note'));
                    }

                    //賦予動作
                    $('.deleteRow').unbind('click');
                    $('.ClickShowInfo').unbind('click');
                    $('.BlurUpdateInfo').unbind('blur');
                    $('.BlurUpdateInfo').unbind('keydown');
                    $('.create_labor_or_equip').unbind('click');
                    $('#delete_report_record').unbind('click');
                    $('.arrow_keys_to_detect').unbind('keydown');
                    $('.arrow_keys_to_detect').keydown(arrow_keys_to_detect);
                    $('.update_report_data').click(update_report_data);
                    $('.check_over_sumnum').change(check_over_sumnum);
                    $('.update_sumnum').change(update_sumnum);
                    $('.create_labor_or_equip').click(create_labor_or_equip);
                    $('.deleteRow').click(deleteRow);
                    $('#delete_report_record').click(delete_report_record);
                    $('#lock_report').click(lock_report);
                    $('#copy_report_num').click(copy_report_num);
                    $('#create_site_material').click(create_site_material);
                    $('.show_update_labor_equip_name_dialog').click(show_update_labor_equip_name_dialog);
                    $('input').change(function(){
                        $('.page_have_change_msg').show();
                        $(this).addClass('value_changed');
                    })
                    $('textarea').change(function(){
                        $('.page_have_change_msg').show();
                        $(this).addClass('value_changed');
                    })
                    
                    $('.ClickShowInfo').click(ClickShowInfo);
                    $('.BlurUpdateInfo').blur(BlurUpdateInfo);
                    $('.BlurUpdateInfo').keydown(function(event) {
                        var $obj = $(this);
                        if (!$obj.is("textarea") && event.which == 13){
                            $obj.blur();
                        }
                    });
                    $(".datepicker").datepicker({
                        changeMonth: true,
                        changeYear: true,
                        onClose: BlurUpdateInfo
                    });
                    $('.sort_laborequip_botton').click(sort_laborequip_botton);
                    $(".uploader").each(function(){
                        var $obj = $(this);
                        var row_id = $obj.attr("row_id");
                        var table_name = $obj.attr("table_name");
                        NewFileUploader($obj, row_id, table_name);
                    });

                    //進度部分
                    $("#loading").fadeOut();
                    $.ajax({
                        url: '/dailyreport/update_report_page_progress/',
                        type: 'POST',
                        data: data,
                        dataType: 'json',
                        success: function (json) {
                            $('#act_percent').html(json['today_progress_rate']);
                            $('#sum_act_percent').html(json['sum_progress_rate']);
                            $('#design_percent').html(json['design_percent']);
                            $('#act_money').html(TransformThousands(json['today_progress_money']));
                            $('#sum_act_money').html(TransformThousands(json['sum_progress_money']));
                            $('#design_money').html(TransformThousands(json['design_money']));
                        },
                        error: function(){
                        }
                    })
                },
                error: function(){
                }
            })
        }

        function show_all_item_sum(){
            var $obj = $(this);
            var report_date = $('#report_date').val();
            var report_type = $('#report_type').val();
            var project_id = $('#project_id').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                report_date: report_date,
                report_type: report_type,
                project_id: project_id,
            };
            $obj.html('<img src="/media/dailyreport/images/loading.gif">');
            $.ajax({
                url: '/dailyreport/get_all_item_sum/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    for (i=0; i<json['items_sum'].length; i++){
                        var item_id = json['items_sum'][i][0];
                        var pre_sum = json['items_sum'][i][1];
                        $('#item_sum_num_' + item_id).attr('pre_sum', pre_sum);
                        var value = parseFloat($('#item_num_' + item_id).val());
                        if (!value) {value = parseFloat($('#span_item_num_' + item_id).text())};
                        if (!value) {value = 0};
                        $('#span_item_sum_num_' + item_id).html(FloatAdd(value, pre_sum));

                        var unit_num = parseFloat($('#td_item_unit_num_' + item_id).attr('value'));
                        var sum_num = parseFloat($('#item_sum_num_' + item_id).attr('pre_sum'));
                        if (FloatAdd(value, sum_num) > unit_num){
                            $('#item_sum_num_' + item_id).attr('bgcolor', '#FF9291');
                        } else if (FloatAdd(value, sum_num) == unit_num){
                            $('#item_sum_num_' + item_id).attr('bgcolor', '#FDFF73');
                        } else {
                            $('#item_sum_num_' + item_id).attr('bgcolor', '');
                        }
                    }
                    $obj.remove()
                },
                error: function(){
                }
            })
        }

        function get_item_sum(){
            var $obj = $(this);
            var report_date = $('#report_date').val();
            var report_type = $('#report_type').val();
            var item_id = $obj.attr('item_id');
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                report_date: report_date,
                report_type: report_type,
                item_id: item_id,
            };
            $.ajax({
                url: '/dailyreport/get_item_sum/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    $('#item_sum_num_' + item_id).attr('pre_sum', json['pre_sum']);
                    var value = parseFloat($('#item_num_' + item_id).val());
                    if (!value) {
                        value = parseFloat($('#span_item_num_' + item_id).text());
                    };
                    if (!value) {value = 0};
                    $obj.html(FloatAdd(value, json['pre_sum']));

                    var unit_num = parseFloat($('#td_item_unit_num_' + item_id).attr('value'));
                    var sum_num = parseFloat($('#item_sum_num_' + item_id).attr('pre_sum'));
                    if (FloatAdd(value, sum_num) > unit_num){
                        $('#item_sum_num_' + item_id).attr('bgcolor', '#FF9291');
                    } else if (FloatAdd(value, sum_num) == unit_num){
                        $('#item_sum_num_' + item_id).attr('bgcolor', '#FDFF73');
                    } else {
                        $('#item_sum_num_' + item_id).attr('bgcolor', '');
                    }
                },
                error: function(){
                }
            })
        }

        function delete_report_record(){
            var report_id = $('#report_id').val();
            var report_type = $('#report_type').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
            };
            data[report_type + '_check'] = false;
            if (confirm('你確定要刪除紀錄嗎？刪除後填寫的數據資料將會清空喔!!!')){
                $.ajax({
                    url: '/dailyreport/api/v1/report/' + report_id + '/',
                    type: 'PUT',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (json, text, xhr) {
                        alert('紀錄已刪除!!!');
                        window.location.reload();
                    },
                    error: REST_ERROR
                })
            }
        }

        function create_site_material(){
            var report_id = $('#report_id').val();
            if (report_id=='-1'){
                alert('請先按下方『送出資料，並更新本日進度』按鈕後，再新增工地材料。');
                return false;
            };
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                report_id: report_id
            };
            $.ajax({
                url: '/dailyreport/create_site_material/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json, text, xhr) {
                    var html = $(json['html']);
                    $('.ClickShowInfo', html).click(ClickShowInfo);
                    $('.BlurUpdateInfo', html).blur(BlurUpdateInfo);
                    $('.BlurUpdateInfo', html).keydown(function(event) {
                        var $obj = $(this);
                        if (!$obj.is("textarea") && event.which == 13){
                            $obj.blur();
                        }
                    });
                    $('.deleteRow', html).click(deleteRow);
                    $('#report_material_items_tbody').append(html)
                },
                error: REST_ERROR
            })
        }


        function lock_report(){
            var $obj = $(this);
            var report_id = $obj.attr('report_id');
            var is_lock = $obj.attr('is_lock');
            if (is_lock=='true'){
                var value = false;
            } else {
                var value = true;
            }
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                lock_c: value
            };
            $.ajax({
                url: '/dailyreport/api/v1/report/' + report_id + '/',
                type: 'PUT',
                data: JSON.stringify(data),
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    window.location.reload();
                },
                error: REST_ERROR
            })
        }

        function create_labor_or_equip(){
            //新增 人員或機具
            var $obj = $(this);
            var type = $obj.attr('type');
            var name = $('#new_' + type + '_name').val();
            if (!name){
                Lobibox.notify('warning', {
                    title: '警告訊息',
                    msg: "請輸入欲新增名稱",
                });
                return false;
            }
            var project_id = $('#project_id').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                type: type,
                name: name,
                project_id: project_id,
            };
            $.ajax({
                url: '/dailyreport/create_labor_or_equip/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    if (json['status']){
                        var html = $(json['html']);
                        $('#sort_laborequip_botton_down_' + json['up_id']).show();
                        $('#new_' + type + '_name').val('');
                        $('.close').click();
                        $('.update_sumnum', html).change(update_sumnum);
                        var $tr = html.appendTo($('#report_' + type + 's_tbody'));
                        $tr.find('.deleteRow').click(deleteRow);
                        $tr.find('.sort_laborequip_botton').click(sort_laborequip_botton);
                        Lobibox.notify('success', {
                            title: '系統訊息',
                            msg: '已新增種類【' + name + '】',
                        });
                    } else {
                        Lobibox.notify('error', {
                            title: '錯誤訊息',
                            msg: json['msg'],
                        });
                    }
                },
                error: function (json) {
                    Lobibox.notify('error', {
                        title: '錯誤訊息',
                        msg: json.responseText,
                    });
                },
            })
        }

        function show_update_labor_equip_name_dialog(){
            var $obj = $(this);
            var row_id = $obj.attr('row_id');
            var name = $obj.closest('td').find('[name="name"]').html();
            $('#update_labor_equip_name_dialog').modal('show');
            $('#new_labor_equip_name').val(name);
            $('#new_labor_equip_name').attr('row_id', row_id);
        }

        function update_labor_equip_name(){
            var row_id = $('#new_labor_equip_name').attr('row_id');
            var name = $('#new_labor_equip_name').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                value: name,
            };
            $.ajax({
                url: '/dailyreport/api/v1/laborequip/' + row_id + '/',
                type: 'PUT',
                data: JSON.stringify(data),
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    Lobibox.notify('success', {
                        title: '系統訊息',
                        msg: '已修改名稱',
                    });
                    $('#tr_labor_' + row_id).find('[name="name"]').html(name);
                    $('#update_labor_equip_name_dialog').modal('hide');
                },
                error: function (json) {
                    Lobibox.notify('error', {
                        title: '錯誤訊息',
                        msg: json.responseText,
                    });
                },
            })
        }
        
        function check_over_sumnum(){
            var $obj = $(this);
            var item_id = $obj.attr('item_id');
            var have_click = false;
            if ($('#item_sum_num_' + item_id).html().indexOf('顯示') > -1){
                $('#span_item_sum_num_' + item_id).click();
                have_click = true;
            }
            var value = parseFloat($obj.val());
            if (!value){
                value = 0;
            };
            if (have_click){
                setTimeout('check_over(' + value + ',' + item_id + ')', 1500);
            } else {
                check_over(value, item_id);
            }
        }

        function check_over(value, item_id){
            var unit_num = parseFloat($('#td_item_unit_num_' + item_id).attr('value'));
            var sum_num = parseFloat($('#item_sum_num_' + item_id).attr('pre_sum'));
            $('#item_sum_num_' + item_id).html(FloatAdd(value, sum_num));
            if (FloatAdd(value, sum_num) > unit_num){
                $('#item_sum_num_' + item_id).attr('bgcolor', '#FF9291');
            } else if (FloatAdd(value, sum_num) == unit_num){
                $('#item_sum_num_' + item_id).attr('bgcolor', '#FDFF73');
            } else {
                $('#item_sum_num_' + item_id).attr('bgcolor', '');
            }
        }

        function update_sumnum(){
            var $obj = $(this);
            var row_id = $obj.attr('row_id');
            var row_name = $obj.attr('row_name');
            var value = parseFloat($obj.val());
            if (!value){
                value = 0;
            }
            var pre_value = parseFloat($('#' + row_name + '_sum_num_' + row_id).attr('pre_value'));
            $('#' + row_name + '_sum_num_' + row_id).html(FloatAdd(value, pre_value));
        }

        function update_report_data(){
            $('#div_update_dutton').hide();
            var $obj = $(this);
            var project_id = $('#project_id').val();
            var report_type = $('#report_type').val();
            var report_date = String(window.location).split('#')[1];
            var morning_weather = $('#morning_weather').val();
            var afternoon_weather = $('#afternoon_weather').val();
            var is_special_day = $obj.attr('is_special_day');
            var info = '';
            var ids = $('#all_item_ids').val().split(',');
            var cut_row_code = '/%/';
            var cut_value_code = '-#$#-';
            var describe_subcontractor = $('#describe_subcontractor').val();
            var sampling = $('#sampling').val();
            var notify = $('#notify').val();
            var note = $('#note').val();
            var i_pre_check = $('#i_pre_check').val();
            var i_project_status = $('#i_project_status').val();

            for (i=0;i<ids.length;i++){
                if ($('#item_num_' + ids[i]).hasClass('value_changed') || $('#item_note_' + ids[i]).hasClass('value_changed')){
                    var num = $('#item_num_' + ids[i]).val();
                    var item_note = $('#item_note_' + ids[i]).val();
                    info += ids[i] + cut_value_code + num + cut_value_code + item_note + cut_row_code;
                }
            }

            var labors = $('.labor_num');
            var labor_info = '';
            for (i=0;i<labors.length;i++){
                var row = $('#' + labors[i].id);
                labor_info += row.attr('row_id') + cut_value_code + row.val() + cut_row_code;
            }

            var equips = $('.equip_num');
            var equip_info = '';
            for (i=0;i<equips.length;i++){
                var row = $('#' + equips[i].id);
                equip_info += row.attr('row_id') + cut_value_code + row.val() + cut_row_code;
            }

            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                morning_weather: morning_weather,
                afternoon_weather: afternoon_weather,
                cut_row_code: cut_row_code,
                cut_value_code: cut_value_code,
                project_id: project_id,
                report_type: report_type,
                report_date: report_date,
                info: info,
                labor_info: labor_info,
                equip_info: equip_info,
                describe_subcontractor: describe_subcontractor,
                sampling: sampling,
                notify: notify,
                note: note,
                i_pre_check: i_pre_check,
                i_project_status: i_project_status,
                is_special_day: is_special_day,
            };

            if ($('#has_professional_item') && $('#has_professional_item').prop('checked')){
                data['has_professional_item'] = 'True';
            } else {
                data['has_professional_item'] = 'False';
            }
            if ($('#pre_education') && $('#pre_education').prop('checked')){
                data['pre_education'] = 'True';
            } else {
                data['pre_education'] = 'False';
            }
            if ($('#safety_equipment') && $('#safety_equipment').prop('checked')){
                data['safety_equipment'] = 'True';
            } else {
                data['safety_equipment'] = 'False';
            }
            if ($('#pre_check') && $('#pre_check').prop('checked')){
                data['pre_check'] = 'True';
            } else {
                data['pre_check'] = 'False';
            }
            if ($('input[name="has_insurance"]').length > 0){
                data['has_insurance'] = $('input[name="has_insurance"]:checked').attr('row_id');
            } else {
                data['has_insurance'] = '3'
            }


            $.ajax({
                url: '/dailyreport/update_report_data/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    if (json['status']){
                        $('#report_id').val(json['report_id']);
                        if (!is_special_day){
                            // 更新本日、累計、預定進度資訊
                            $('#act_percent').html('<img src="/media/dailyreport/images/loading.gif">即時計算中');
                            $('#sum_act_percent').html('<img src="/media/dailyreport/images/loading.gif">即時計算中');
                            $('#design_percent').html('<img src="/media/dailyreport/images/loading.gif">即時計算中');
                            $("html, body").animate({scrollTop:150}, "medium");
                            
                            // 加入刪除日報表
                            $('#delete_report_record').show();

                            // 將小日曆改變成已填寫的顏色
                            $('.' + report_date).addClass('reported');
                            color_dates[report_date] = 'reported';

                            var data = {
                                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                                project_id: project_id,
                                report_type: report_type,
                                report_date: report_date,
                            }
                            $("#loading").fadeOut();
                            $.ajax({
                                url: '/dailyreport/update_report_page_progress/',
                                type: 'POST',
                                data: data,
                                dataType: 'json',
                                success: function (json) {
                                    $('#act_percent').html(json['today_progress_rate']);
                                    $('#sum_act_percent').html(json['sum_progress_rate']);
                                    $('#design_percent').html(json['design_percent']);
                                    $('#act_money').html(TransformThousands(json['today_progress_money']));
                                    $('#sum_act_money').html(TransformThousands(json['sum_progress_money']));
                                    $('#design_money').html(TransformThousands(json['design_money']));
                                },
                                error: function(){
                                }
                            })
                        } else {
                            // 將小日曆改變成假日已填寫的顏色
                            $('.' + report_date).removeClass('date_off');
                            $('.' + report_date).removeClass('date_off_rain');
                            $('.' + report_date).removeClass('date_off_rest');
                            $('.' + report_date).addClass('date_off_reported');
                            color_dates[report_date] = 'date_off_reported';
                        }
                        $("#success_message").css('z-index', 10000).show();
                        $("#success_message").fadeOut(3500);
                        $('.page_have_change_msg').hide();
                        $('.value_changed').removeClass('value_changed');
                    } else {
                        alert(json['msg']);
                    }
                },
                error: function(){
                }
            })
            $('#div_update_dutton').show();
        }

        function copy_report_num(){
            var ids = $('#all_item_ids').val().split(',');
            for (i=0;i<ids.length;i++){
                var another_num = $('#span_item_another_num_' + ids[i]).html();
                $('#item_num_' + ids[i]).val(another_num);
                
            }
            for (m=0;m<ids.length;m++){
                $('#item_num_' + ids[m]).change();
            }
            alert('複製完成!!!');
        }

        function create_test_record(){
            var testtype = $('#new_testtype').val();
            var record_name = $('#new_record_name').val();
            var type = $('#new_type').val();
            var record_date = $('#new_record_date').html();
            var qualified = $('#new_qualified').val();
            var qualified_date = $('#new_qualified_date').val();
            var record_memo = $('#new_record_memo').val();
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                testtype: testtype,
                record_name: record_name,
                type: type,
                record_date: record_date,
                qualified: qualified,
                qualified_date: qualified_date,
                record_memo: record_memo
            };
            $.ajax({
                url: '/dailyreport/create_test_record/',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (json) {
                    if (json['status']){
                        $('#new_record_name').attr('value', '');
                        $('#new_type').attr('value', '');
                        $('#new_qualified').attr('value', 'True');
                        $('#new_qualified_date').attr('value', '');
                        $('#new_record_memo').attr('value', '');
                        $('#create_test_record').modal('hide');
                        
                        var html = $(json['html']);
                        $('.deleteRow', html).click(deleteRow);
                        $('.ClickShowInfo', html).click(ClickShowInfo);
                        $('.BlurUpdateInfo', html).blur(BlurUpdateInfo);
                        $('.BlurUpdateInfo', html).keydown(function(event) {
                            var $obj = $(this);
                            if (!$obj.is("textarea") && event.which == 13){
                                $obj.blur();
                            }
                        });
                        $('#delete_report_record', html).click(delete_report_record);
                        
                        $(".datepicker", html).datepicker({
                            changeMonth: true,
                            changeYear: true,
                            onClose: BlurUpdateInfo
                        });
                        $('.click_update_testrecord_qualified', html).click(click_update_testrecord_qualified);

                        html.insertBefore($('#insert_place_test_record'));

                        $("#td_record_fileupload_" + json['row_id'] + " button").each(function(){
                            var $obj = $(this);
                            var row_id = $obj.attr("row_id");
                            var table_name = $obj.attr("table_name");
                            NewFileUploader($obj, row_id, table_name);
                        });

                        
                    } else {
                        alert(json['msg']);
                    }
                },
                error: function(){
                }
            })
        }

        function sort_laborequip_botton(){
            var $obj = $(this);
            var field_type = $obj.attr('field_type');
            var row_id = $obj.attr('row_id');
            var duration = $obj.attr('duration');
            var data = {
                csrfmiddlewaretoken: CSRFMIDDLEWARETOKEN,
                sort_duration: duration
            };
            $.ajax({
                url: '/dailyreport/api/v1/laborequip/' + row_id + '/',
                type: 'PUT',
                data: JSON.stringify(data),
                contentType: 'application/json',
                dataType: 'json',
                success: function (json, text, xhr) {
                    $('#sort_laborequip_botton_up_' + row_id).show();
                    $('#sort_laborequip_botton_down_' + row_id).show();
                    if (duration=='up'){
                        $('#tr_' + field_type + '_' + row_id).insertBefore($('#tr_' + field_type + '_' + json['down_id']));
                        $('#sort_laborequip_botton_up_' + json['down_id']).show();
                        $('#sort_laborequip_botton_down_' + json['down_id']).show();
                        if (json['is_first']){
                            $('#sort_laborequip_botton_up_' + row_id).hide();
                        }
                        if (json['down_is_last']){
                            $('#sort_laborequip_botton_down_' + json['down_id']).hide();
                        }
                    } else if (duration=='down') {
                        $('#tr_' + field_type + '_' + row_id).insertAfter($('#tr_' + field_type + '_' + json['up_id']));
                        $('#sort_laborequip_botton_up_' + json['up_id']).show();
                        $('#sort_laborequip_botton_down_' + json['up_id']).show();
                        if (json['is_last']){
                            $('#sort_laborequip_botton_down_' + row_id).hide();
                        }
                        if (json['up_is_first']){
                            $('#sort_laborequip_botton_up_' + json['up_id']).hide();
                        }
                    }
                    $('#tr_' + field_type + '_' + row_id).effect("highlight", {color: 'green'}, 1500);
                },
                error: function (data) {
                    alert(data.responseText);
                }
            })
        }

        $(document).ready(function(){
            CSRFMIDDLEWARETOKEN = $('input[name=csrfmiddlewaretoken]').val();
            $('.reload').click(
                function(){
                    window.location.reload();
                }
            );
            if (report_date) {
                var report_date_obj = $.fromStringtoDateObj(report_date);
                var offset_days = (report_date_obj - new Date()) / (1000*60*60*24);
            } else {
                var report_date_obj = $.fromStringtoDateObj('{{ last_day }}');
                var offset_days = (report_date_obj - new Date()) / (1000*60*60*24);
            }
            $('#datepicker').datepicker({
                defaultDate: offset_days,
                numberOfMonths: 3,
                dateFormat: 'yy-mm-dd',
                changeYear: true,
                changeMonth: true,
                showMonthAfterYear: false,
                showOtherMonths: true,
                highlightWeek: false,
                showWeeks: false,
                stepMonths: 1,
                firstDay: 0,
                minDate: $.fromStringtoDateObj('{{ engprofile.start_date|date:"Y-m-d" }}'),
                maxDate: new Date(),
                beforeShowDay: updateColorDateOnDatePicker,
                onSelect: function(date_str){
                    window.location = '#' + date_str;
                    updateReportPage(date_str);
                }
            });
            $('.' + report_date).attr('style', 'background: #C7EFA1 !important;');
            $('.ui-datepicker-week-end-cell').each(function(){
                $(this).removeClass('ui-datepicker-week-end-cell');
            });

            $('.updateReportPage').click(function(){
                // 所有已填寫報表，被點選後， reload 新網址。
                window.location = $(this).attr('href');
                window.location.reload();
            });
            if (report_date){
                updateReportPage(report_date);
            } else {
                $('#reports').show();
                $('#report').hide();
            }
            $('.deleteRow').click(deleteRow);
            $('.update_sumnum').change(update_sumnum);
            $('.update_sumnum').change();
        });
    </script>
{% endblock body %}
